#!/bin/bash
set -e
mkdir ssh/
ssh-keygen -t rsa -m PEM -f ssh/test-key -N ""

USER_PASSWORD="$(openssl rand -hex 16)"
MYSQL_ADMIN_PASSWORD="$(openssl rand -hex 16)"
MYSQL_USER_PASSWORD="$(openssl rand -hex 16)"
GITEA_USER_PASSWORD="$(openssl rand -hex 16)"
KEYCLOAK_PASSWORD="$(openssl rand -hex 16)"
LDAP_BIND_CREDENTIAL="$(openssl rand -hex 16)"
KEYCLOAK_JENKINS_SECRET="$(uuidgen)"
KEYCLOAK_GITEA_SECRET="$(uuidgen)"

echo
echo "+----------------+-------+----------------------------------+"
echo "| Service        | User  | Generated password               |"
echo "+----------------+-------+----------------------------------+"
echo "| Jenkins/Gitea  | demo  | $USER_PASSWORD |"
echo "| Keycloak       | admin | $KEYCLOAK_PASSWORD |"
echo "| Gitea (admin)  | gitea | $GITEA_USER_PASSWORD |"
echo "+----------------+-------+----------------------------------+"
echo

cat >docker-compose.yml <<EOF
---
version: "3.1"

services:
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile-jenkins
    ports:
      - "4040:4040"
    depends_on:
      - keycloak
    environment:
      GITEA_PASSWORD: "$USER_PASSWORD"
      KEYCLOAK_JENKINS_SECRET: "$KEYCLOAK_JENKINS_SECRET"
      SSH_PRIVATE_KEY: |-
$(sed "s/^/        /" ssh/test-key)

  worker:
    build:
      context: .
      dockerfile: Dockerfile-worker

  gitea:
    build:
      context: .
      dockerfile: Dockerfile-gitea
    environment:
      DB_TYPE: mysql
      DB_HOST: db:3306
      DB_NAME: gitea
      DB_USER: gitea
      SSH_PORT: 2222
      ROOT_URL: http://localhost:3000
      GITEA_PASSWORD: "$GITEA_USER_PASSWORD"
      LDAP_BIND_CREDENTIAL: "$LDAP_BIND_CREDENTIAL"
      USER_PASSWORD: "$USER_PASSWORD"
      DB_PASSWD: "$MYSQL_USER_PASSWORD"
      RUN_MODE: "prod"
      DISABLE_REGISTRATION: "true"
      INSTALL_LOCK: "true"
      KEYCLOAK_URL: "http://localhost:8080"
      KEYCLOAK_GITEA_SECRET: "$KEYCLOAK_GITEA_SECRET"
    ports:
      - "3000:3000"
      - "2222:22"
    depends_on:
      - db
      - keycloak
      - ldap

  db:
    image: mariadb:10.5
    environment:
      MYSQL_ROOT_PASSWORD: "$MYSQL_ADMIN_PASSWORD"
      MYSQL_DATABASE: gitea
      MYSQL_USER: gitea
      MYSQL_PASSWORD: "$MYSQL_USER_PASSWORD"

  ldap:
    build:
      context: .
      dockerfile: Dockerfile-ldap
    environment:
      LDAP_ADMIN_PASSWORD: "$LDAP_BIND_CREDENTIAL"
      USER_PASSWORD: "$USER_PASSWORD"
      LDAP_SEED_INTERNAL_LDIF_PATH: /tmp/ldifs

  keycloak:
    build:
      context: .
      dockerfile: Dockerfile-keycloak
    environment:
      KEYCLOAK_HOSTNAME: localhost
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: "$KEYCLOAK_PASSWORD"
      KEYCLOAK_IMPORT: /tmp/ci-realm.json
      KEYCLOAK_JENKINS_SECRET: "$KEYCLOAK_JENKINS_SECRET"
      KEYCLOAK_GITEA_SECRET: "$KEYCLOAK_GITEA_SECRET"
      LDAP_BIND_CREDENTIAL: "$LDAP_BIND_CREDENTIAL"
    ports:
      - "8080:8080"
EOF

cat >ldap/init/create-user.ldif <<EOF
dn: ou=users,dc=example,dc=org
objectclass: top
objectclass: organizationalUnit
ou: users
description: all users

dn: uid=demo,ou=users,dc=example,dc=org
uid: demo
cn: John
sn: Doe
objectClass: top
objectClass: posixAccount
objectClass: inetOrgPerson
loginShell: /bin/bash
homeDirectory: /home/user
uidNumber: 14583102
gidNumber: 14564100
userPassword: $USER_PASSWORD
mail: demo@example.com
gecos: demo
EOF
