#!/bin/bash
set -e
mkdir ssh/
ssh-keygen -t rsa -m PEM -f ssh/test-key -N ""

JENKINS_PASSWORD="$(openssl rand -hex 16)"
MYSQL_ADMIN_PASSWORD="$(openssl rand -hex 16)"
MYSQL_USER_PASSWORD="$(openssl rand -hex 16)"
GITEA_USER_PASSWORD="$(openssl rand -hex 16)"

echo
echo "+---------+-------+----------------------------------+"
echo "| Service | User  | Generated password               |"
echo "+---------+-------+----------------------------------+"
echo "| Jenkins | admin | $JENKINS_PASSWORD |"
echo "| Mysql   | root  | $MYSQL_ADMIN_PASSWORD |"
echo "| Mysql   | gitea | $MYSQL_USER_PASSWORD |"
echo "| Gitea   | gitea | $GITEA_USER_PASSWORD |"
echo "+---------+-------+----------------------------------+"
echo

cat >docker-compose.yml <<EOF
version: "3.1"

services:
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile-jenkins
    ports:
      - "8080:8080"
    environment:
      ADMIN_PASSWORD: "$JENKINS_PASSWORD"
      GITEA_PASSWORD: "$GITEA_USER_PASSWORD"
      SSH_PRIVATE_KEY: |-
$(sed "s/^/        /" ssh/test-key)

  worker:
    build:
      context: .
      dockerfile: Dockerfile-worker

  gitea:
    build:
      context: .
      dockerfile: Dockerfile-gitea
    environment:
      DB_TYPE: mysql
      DB_HOST: db:3306
      DB_NAME: gitea
      DB_USER: gitea
      SSH_PORT: 2222
      ROOT_URL: http://gitea:3000
      GITEA_USER: gitea
      GITEA_PASSWORD: "$GITEA_USER_PASSWORD"
      DB_PASSWD: "$MYSQL_USER_PASSWORD"
      RUN_MODE: "prod"
      DISABLE_REGISTRATION: "true"
      INSTALL_LOCK: "true"
    ports:
      - "3000:3000"
      - "2222:22"
    depends_on:
      - db

  db:
    image: mariadb:latest
    environment:
      MYSQL_ROOT_PASSWORD: "$MYSQL_ADMIN_PASSWORD"
      MYSQL_DATABASE: gitea
      MYSQL_USER: gitea
      MYSQL_PASSWORD: "$MYSQL_USER_PASSWORD"
EOF
